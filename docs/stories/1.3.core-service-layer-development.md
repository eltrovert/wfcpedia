# Story 1.3: Core Service Layer Development

## Status

Draft

## Story

**As a** development foundation,  
**I want** complete service layer abstractions before UI development,  
**so that** UI components have reliable, tested services to consume.

## Acceptance Criteria

1. **Café Management Services**
   - CafeService with business logic for café operations
   - LocationService for geolocation and address handling
   - ImageService for photo upload and compression
   - ValidationService for data quality enforcement

2. **User Session and State Management**
   - UserSessionService for anonymous user tracking
   - PreferencesService for user settings persistence
   - VisitHistoryService for WFC Journal functionality
   - ContributionTrackingService for community engagement

3. **Caching and Sync Services**
   - CacheService for intelligent data caching
   - SyncService for offline queue management
   - NetworkService for connection monitoring
   - StorageService for local data management

4. **Service Integration Layer**
   - Service locator pattern for dependency injection
   - Error boundary services for graceful failure handling
   - Analytics service for usage tracking
   - Performance monitoring service integration

5. **Service Testing and Documentation**
   - Comprehensive unit tests for all services
   - Integration tests between services
   - Service API documentation with usage examples
   - Performance benchmarks for mobile optimization

## Tasks / Subtasks

- [ ] **Task 1: Café Management Services Implementation** (AC: 1)
  - [ ] Create CafeService with CRUD operations and business logic
  - [ ] Implement LocationService for GPS/address handling with Indonesian city support
  - [ ] Build ImageService for photo upload, compression, and WebP conversion
  - [ ] Develop ValidationService using Zod schemas for data quality enforcement
  - [ ] Integrate services with existing GoogleSheetsService

- [ ] **Task 2: User Session and State Management** (AC: 2)
  - [ ] Create UserSessionService for anonymous tracking with UUID generation
  - [ ] Implement PreferencesService with IndexedDB persistence
  - [ ] Build VisitHistoryService for WFC Journal tracking functionality
  - [ ] Develop ContributionTrackingService for community engagement metrics
  - [ ] Integrate Zustand state management for session data

- [ ] **Task 3: Caching and Sync Services Enhancement** (AC: 3)
  - [ ] Enhance existing CacheService with intelligent invalidation strategies
  - [ ] Improve SyncService with retry logic and conflict resolution
  - [ ] Create NetworkService for connection monitoring and adaptation
  - [ ] Implement StorageService as unified local data management layer
  - [ ] Add background sync processing with worker support

- [ ] **Task 4: Service Integration and Architecture** (AC: 4)
  - [ ] Implement service locator pattern for dependency injection
  - [ ] Create error boundary services with graceful failure handling
  - [ ] Build analytics service for usage tracking integration
  - [ ] Add performance monitoring service with mobile metrics
  - [ ] Create service registry and initialization system

- [ ] **Task 5: Testing and Documentation** (AC: 5)
  - [ ] Write comprehensive unit tests for all services (90%+ coverage)
  - [ ] Create integration tests between services and data layer
  - [ ] Document service APIs with usage examples and patterns
  - [ ] Implement performance benchmarks for mobile optimization
  - [ ] Validate service layer with mock data and error scenarios

## Dev Notes

### **Previous Story Insights**

Google Sheets backend integration successfully established with GoogleSheetsService, rate limiting,
IndexedDB caching, and comprehensive error handling. Service layer foundation ready with proper
TypeScript interfaces, Zod validation, and 90%+ test coverage achieved.

### **Service Architecture Requirements** [Source: architecture/backend-architecture.md#google-sheets-service-layer]

**Core Service Pattern:**

- Service classes with dependency injection and caching layers
- Offline-first architecture with sync queue management
- Error handling with exponential backoff and fallback strategies
- Performance optimization with batch operations and compression

**Service Layer Structure:**

- `CafeService` - Business logic layer over GoogleSheetsService
- `LocationService` - GPS, geolocation, and Indonesian address handling
- `ImageService` - Photo upload, compression, and WebP optimization
- `ValidationService` - Zod schema validation and data quality enforcement
- `UserSessionService` - Anonymous user tracking and preferences
- `SyncService` - Enhanced offline queue with conflict resolution
- `CacheService` - Intelligent caching with TTL and invalidation
- `NetworkService` - Connection monitoring and network adaptation

### **Data Models and Interfaces** [Source: architecture/data-models.md#core-entities]

**Café Entity Structure:**

- `Cafe` interface with id (UUID), name, location (address, coordinates, city, district)
- `workMetrics` object with wifiSpeed, comfortRating (1-5), noiseLevel, amenities array
- `operatingHours` object with day-specific open/close times and 24-hour flags
- `images` array with url, thumbnailUrl, uploadedBy, uploadedAt
- `community` object with loveCount, lastUpdated, contributorId, verificationStatus

**User Session Entity:**

- `UserSession` interface with sessionId (UUID), preferences, visitHistory
- Anonymous tracking with location preferences and filter settings
- Contribution tracking for cafesAdded, ratingsGiven, photosUploaded
- Visit history with cafeId, visitedAt, duration, rating

**Community Rating Entity:**

- `CafeRating` interface with cafeId, sessionId, workMetrics (optional updates)
- Comments (max 280 chars), photos array, loveGiven boolean, ratedAt timestamp

### **Technology Stack Requirements** [Source: architecture/tech-stack.md]

**State Management:**

- Zustand for lightweight state management
- React Query for server state caching and synchronization
- IndexedDB + LocalStorage for offline data persistence

**Data Processing:**

- Browser APIs + Canvas for image processing and compression
- WebP conversion for mobile optimization
- Zod for runtime validation and schema enforcement

**Service Integration:**

- Google Sheets API v4 with rate limit awareness
- Offline-first patterns with background sync
- Error boundaries and graceful degradation

### **File Locations and Structure** [Source: architecture/project-structure.md]

**Service Layer Files:**

- `src/services/cafeService.ts` - Main café business logic service
- `src/services/locationService.ts` - GPS and address handling service
- `src/services/imageService.ts` - Photo upload and compression service
- `src/services/validationService.ts` - Data validation and quality enforcement
- `src/services/userSessionService.ts` - Anonymous user tracking service
- `src/services/preferencesService.ts` - User preferences persistence
- `src/services/visitHistoryService.ts` - WFC Journal functionality
- `src/services/contributionTrackingService.ts` - Community engagement metrics
- `src/services/networkService.ts` - Connection monitoring service
- `src/services/storageService.ts` - Unified local data management
- `src/services/index.ts` - Service exports and initialization

**State Management Files:**

- `src/stores/userStore.ts` - User session and preferences state
- `src/stores/uiStore.ts` - UI state management
- `src/stores/cacheStore.ts` - Data caching state

**Utilities:**

- `src/utils/performance.ts` - Mobile performance utilities
- `src/utils/network.ts` - Network condition detection (already exists)
- `src/utils/validation.ts` - Validation helpers (already exists)

### **Critical Development Rules** [Source: architecture/coding-standards.md#critical-ai-development-rules]

- **ALWAYS validate user input** before processing using Zod schemas
- **ALWAYS handle errors gracefully** with fallbacks and proper error boundaries
- **ALWAYS use TypeScript strictly** - never use 'any' type
- **ALWAYS implement offline-first patterns** with network fallbacks
- **ALWAYS optimize for mobile performance** with pagination, lazy loading
- **ALWAYS implement proper loading states** with skeletons and error states
- **ALWAYS implement accessibility** with ARIA labels, 44px touch targets

### **IndexedDB Schema Integration** [Source: architecture/database-schema.md#indexeddb-schema-client-side]

**Required IndexedDB Stores:**

- `cafes` store with cafe.id key, indexes on city, updated_at, love_count
- `user_sessions` store with session.id key, indexes on created_at
- `sync_queue` store for offline operations with type, data, retries, created_at
- `cache` store with cache key, data, timestamp, ttl for intelligent caching

**Data Transformation Requirements:**

- Transform Google Sheets rows to typed Café objects with validation
- Handle JSON parsing for complex fields (amenities, operating_hours, images)
- Maintain data consistency between cache and live data

### **Performance and Mobile Optimization**

**Mobile-First Service Design:**

- Batch operations for efficient data handling
- Image compression and WebP conversion for bandwidth optimization
- Intelligent caching with 1-hour TTL and stale fallback
- Background sync with exponential backoff retry logic
- Network condition adaptation for Indonesian mobile networks

### Testing

**Testing Requirements for Story 1.3** [Source: architecture/testing-strategy.md#testing-pyramid]:

- **Unit Tests (70%)**: Test all service methods with comprehensive mocks and validation
- **Integration Tests (20%)**: Test service interactions and data flow between services
- **Performance Tests**: Benchmark service operations for mobile network conditions
- **File Locations**: `tests/services/unit/`, `tests/services/integration/`,
  `tests/services/performance/`
- **Frameworks**: Vitest for unit/integration testing with service mocks
- **Coverage Target**: 90%+ for service layer (critical requirement)
- **Service Testing**: Mock IndexedDB, Google Sheets API, and network conditions
- **Error Testing**: Test failure modes, retry logic, and fallback mechanisms

**Specific Test Cases Required:**

- Service initialization and dependency injection
- Data validation and error handling for invalid inputs
- Offline functionality and sync queue management
- Cache invalidation and TTL behavior
- Network failure scenarios and graceful degradation
- Mobile performance under various network conditions

## Change Log

| Date       | Version | Description                                         | Author       |
| ---------- | ------- | --------------------------------------------------- | ------------ |
| 2025-08-14 | 1.0     | Initial story creation based on Epic 1 requirements | Scrum Master |

## Dev Agent Record

### Agent Model Used

[To be filled by dev agent]

### Debug Log References

[To be filled by dev agent]

### Completion Notes List

[To be filled by dev agent]

### File List

[To be filled by dev agent]

## QA Results

[To be filled by QA agent]
